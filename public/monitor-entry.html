<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Monitoring â€” Enter API Key</title>
    <style>
      body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:#f3f4f6; margin:0 }
      .container { max-width:1100px; margin:28px auto; padding:18px }
      .card { background:white; padding:18px; border-radius:10px; box-shadow:0 6px 20px rgba(2,6,23,0.04) }
      .row { display:flex; gap:12px; align-items:center }
      input[type="text"] { padding:8px 10px; border-radius:8px; border:1px solid #e6e9ef }
      button { padding:8px 12px; border-radius:8px; border:0; background:#2563eb; color:white }
      .error { color:#b91c1c }
      #monitor-root { margin-top:18px }
      .small { font-size:13px; color:#6b7280 }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Advanced Monitoring</h2>
        <div class="small">Enter your monitor API key to open the single-page monitoring console (realtime metrics, health, performance charts, and load tests).</div>
        <div style="margin-top:12px" class="row">
          <input id="apiKeyInput" type="text" placeholder="Enter monitor API key" style="flex:1" />
          <button id="openBtn">Open</button>
        </div>
        <div id="err" class="error" style="margin-top:8px; display:none"></div>
      </div>

      <!-- monitor root where SPA will mount after validation -->
      <div id="monitor-root"></div>
    </div>

    <script>
      (function(){
        const openBtn = document.getElementById('openBtn')
        const input = document.getElementById('apiKeyInput')
        const err = document.getElementById('err')

        function showError(msg) {
          err.style.display = 'block'
          err.textContent = msg
        }
        function clearError(){ err.style.display='none'; err.textContent=''}

        async function validateKey(key) {
          try {
            const res = await fetch('/monitor/counts?api_key=' + encodeURIComponent(key), { method: 'GET' })
            if (!res.ok) {
              return { ok:false, status: res.status }
            }
            const json = await res.json()
            return { ok:true, body: json }
          } catch (e) {
            return { ok:false }
          }
        }

        async function openMonitor() {
          clearError()
          const key = input.value && input.value.trim()
          if (!key) return showError('Please enter the API key')
          openBtn.disabled = true
          openBtn.textContent = 'Checking...'
          const res = await validateKey(key)
          if (!res.ok) {
            openBtn.disabled = false
            openBtn.textContent = 'Open'
            return showError('Invalid API key or server unreachable (HTTP ' + (res.status || '') + ')')
          }
          // store key and dynamically load SPA bundle so it boots with key in localStorage
          try { localStorage.setItem('monitor_api_key', key) } catch(e) {}
          try { document.cookie = 'monitor_api_key=' + encodeURIComponent(key) + '; path=/'; } catch(e) {}
          // show loading indicator
          const root = document.getElementById('monitor-root')
          const loading = document.createElement('div')
          loading.textContent = 'Loading monitor...'
          loading.style.padding = '16px'
          root.appendChild(loading)

          // dynamic script load
          const s = document.createElement('script')
          s.src = '/monitor-app/bundle.js'
          s.defer = true
          s.onload = function(){ loading.remove() }
          s.onerror = function(){ loading.textContent = 'Failed to load monitor bundle' }
          document.body.appendChild(s)
        }

        openBtn.addEventListener('click', openMonitor)
        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); openMonitor() } })

        // If api_key is in URL query, prefill and auto-open
        try {
          const params = new URLSearchParams(window.location.search)
          const q = params.get('api_key')
          if (q) { input.value = q; openMonitor() }
        } catch(e){}
      })()
    </script>
  </body>
</html>
